name: Auto Rollback on Argo CD Failure

on:
  repository_dispatch:
    types: [argo-degraded]

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Get Argo CD Token
        env:
          ARGOCD_SERVER: "https://localhost:8080"
          ARGOCD_USERNAME: "admin"
          ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}
        run: |
          TOKEN=$(curl -k -s -X POST \
            "$ARGOCD_SERVER/api/v1/session" \
            -d "{\"username\": \"$ARGOCD_USERNAME\", \"password\": \"$ARGOCD_PASSWORD\"}" \
            -H "Content-Type: application/json" \
            | jq -r .token)
          echo "ARGOCD_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "Argo CD Token: $TOKEN"

      - name: Get Last Healthy Revision
        env:
          ARGOCD_SERVER: "https://localhost:8080"
          APP_NAME: "seminar-nextjs"
          ARGOCD_TOKEN: ${{ env.ARGOCD_TOKEN }}
        run: |
          curl -k -s -X GET \
            "$ARGOCD_SERVER/api/v1/applications/$APP_NAME" \
            -H "Authorization: Bearer $ARGOCD_TOKEN" \
            -H "Content-Type: application/json" \
            | jq '.status.history | reverse | map(select(.health.status == "Healthy")) | .[0]' > healthy_commit.json
          cat healthy_commit.json
          LAST_HEALTHY_COMMIT=$(jq -r '.revision' healthy_commit.json)
          echo "LAST_HEALTHY_COMMIT=$LAST_HEALTHY_COMMIT" >> $GITHUB_ENV
          echo "Last Healthy Commit: $LAST_HEALTHY_COMMIT"

      - name: Check if healthy commit was found
        if: env.LAST_HEALTHY_COMMIT == ''
        run: |
          echo "Error: No healthy commit found!"
          exit 1

      - name: Print received data
        run: |
          echo "App: ${{ github.event.client_payload.app }}"
          echo "Failed Revision: ${{ github.event.client_payload.failed_revision }}"
          echo "Last Healthy Commit: ${{ env.LAST_HEALTHY_COMMIT }}"

      - name: Rollback to Last Healthy Commit
        run: |
          git config user.name "GitOps Bot"
          git config user.email "gitops-bot@example.com"
          git revert ${{ github.event.client_payload.failed_revision }}..${{ env.LAST_HEALTHY_COMMIT }} --no-edit || true
          git push origin HEAD:main

      - name: Verify rollback
        run: |
          git log -1
